﻿# File Descriptors的设置原文链接：[https://blog.csdn.net/huanongdetian/article/details/78087356](https://blog.csdn.net/huanongdetian/article/details/78087356)---### 设置多少合适？a、/proc/sys/fs/file-max决定了当前内核可以打开的最大的文件句柄数> The value  in  file-max  denotes  the  maximum number of file handles that the Linux kernel will allocate. When you get a lot of error messages about running out of  file handles, you might want to raise this limit. The default value is 10% of  RAM in kilobytes.  To  change it, just  write the new number  into the file意思是file-max一般为内存大小（KB）的10%来计算，如果使用shell，可以这样计算```grep -r MemTotal /proc/meminfo | awk '{printf("%d",$2/10)}'```b、/proc/sys/fs/file-nrfile-nr 中的值由三部分组成，分别为：- 已经分配的文件句柄数- 已经分配单没有使用的文件句柄数- 最大文件句柄数第二项的值总为0，这并不是一个错误，它实际上意味着已经分配的文件句柄无一浪费的都已经被使用了> Historically, the three values in file-nr denoted the number of allocated file handles,  the number of  allocated but  unused file  handles, and  the maximum number of file handles. Linux 2.6 always  reports 0 as the number of free file handles -- this  is not an error,  it just means that the  number of allocated file handles exactly matches the number of used file handles.查找文件句柄问题的时候，还有一个很实用的程序lsof，可以很方便看到某个进程开了那些句柄，也可以看到某个文件/目录被什么进程占用了```lsof -n |awk '{print $2}'|sort|uniq -c |sort -nr|more```这两个参数可以让你来决定设置多少比较合适### 如何设置？系统级别的设置```sysctl -w fs.file-max=100000  //临时生效vi /etc/sysctl.conf  +fs.file-max = 100000 //永久生效```查看设置```cat /proc/sys/fs/file-maxsysctl fs.file-max```用户级别的设置在/etc/security/limits.conf文件，可以对系统用户组，进行cpu、文件数等限制的，通过它可以针对某个用户或全部进行限制（*表示所有用户、soft表示可以超出，但只是警告；hard表示绝对不能超出，unlimited用于表示不限制）也可以放在/etc/profile文件里面，下面是该文件里面的默认参数：```ulimit -S -c 0 > /dev/null 2>&1``````vi /etc/security/limits.conf ```//添加```httpd soft nofile 4096httpd hard nofile 10240 ``` //查看```su - httpdulimit -Hnulimit -Sn ```//如果不生效/etc/pam.d/login中加上pam_limts.so文件 ```session required pam_limits.so```### 有什么区别？ulimit -n and /proc/sys/fs/file-max 有什么区别？1、file-max  是内核级别的，所有的进程总和不能超过这个数2、ulimit是进程级别的```[root@dev ~]# ulimit -n1024[root@dev ~]# lsof | grep me | wc -l8145```perl脚本查看```#!/usr/bin/perl $count = 0;@filedescriptors; while ($count <= 1024) {    $FILE = ${count};    open $FILE, ">", "/tmp/example$count" or die "\n\n FDs: $count $!";    push(@filedescriptors, $FILE);    $count ++;} ```//FDs: 1021 Too many open files at ./test.pl line 8.//1021 because there were 3 open file descriptors before reaching the while loop (stdout, stdin and stderr) 